<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual USB Storage</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #16a34a;
            --success-dark: #15803d;
            --warning: #d97706;
            --warning-dark: #b45309;
            --danger: #dc2626;
            --danger-dark: #b91c1c;
            --background: #f3f4f6;
            --surface: #ffffff;
            --text: #111827;
            --text-secondary: #6b7280;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: var(--surface);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(-100%);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 30;
        }

        .sidebar.open {
            transform: translateX(0);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .sidebar-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 32px;
            width: 32px;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .sidebar-toggle span {
            width: 20px;
            height: 2px;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2px;
        }

        .sidebar.open .sidebar-toggle span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .sidebar.open .sidebar-toggle span:nth-child(2) {
            opacity: 0;
            transform: translateX(-10px);
        }

        .sidebar.open .sidebar-toggle span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .file-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background: var(--surface);
            border: 1px solid transparent;
        }

        .file-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-image: linear-gradient(to right, var(--primary), var(--success)) 1;
        }

        .auth-card {
            background: var(--surface);
            border: 1px solid #e5e7eb;
            animation: slideIn 0.5s ease-in;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-field {
            transition: all 0.3s ease;
            background-color: var(--surface);
            color: var(--text);
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5);
        }

        .password-wrapper svg {
            color: var(--text-secondary);
        }

        .password-wrapper svg:hover {
            color: var(--text);
        }

        .error-message {
            transition: opacity 0.3s ease;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 40;
            padding: 1rem 1.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(20px);
            animation: slideInAlert 0.3s forwards;
        }

        .alert-success {
            background-color: #dcfce7;
            color: var(--success-dark);
            border-left: 4px solid var(--success);
        }

        .alert-error {
            background-color: #fee2e2;
            color: var(--danger-dark);
            border-left: 4px solid var(--danger);
        }

        @keyframes slideInAlert {
            to { opacity: 1; transform: translateX(0); }
        }

        button {
            touch-action: manipulation; /* Disable double-tap zoom */
        }

        .progress-bar {
            width: 100%;
            background-color: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--success);
            transition: width 0.3s ease;
        }

        @media (max-width: 640px) {
            .sidebar { width: 80vw; }
            .auth-card {
                padding: 1.5rem;
                margin: 1rem;
            }
            .input-field {
                font-size: 1rem; /* Larger text for mobile */
            }
            .alert {
                width: calc(100% - 2rem);
                right: 1rem;
                top: 1rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header id="header" class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 shadow-md sticky top-0 z-10 hidden">
        <div class="container mx-auto flex justify-between items-center flex-col sm:flex-row gap-4">
            <div class="flex items-center gap-4">
                <button id="sidebarToggle" class="sidebar-toggle hidden">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1 class="text-2xl font-bold">Virtual USB Storage</h1>
            </div>
        </div>
    </header>

    <div id="sidebar" class="sidebar">
        <div class="p-6 flex flex-col h-full">
            <h2 class="text-xl font-semibold mb-6">Menu</h2>
            <div id="sidebarUserInfo" class="flex flex-col gap-4">
                <span id="sidebarLoggedInUser" class="font-semibold text-base bg-gray-100 p-3 rounded-md"></span>
                <div id="currentPath" class="text-sm font-semibold bg-gray-100 p-3 rounded-md"></div>
                <button onclick="logout()" class="btn-danger bg-gradient-to-r from-red-600 to-red-800 text-white px-4 py-2 rounded-md hover:from-red-800 hover:to-red-600 transition-all">Logout</button>
            </div>
            <div class="mt-auto text-sm text-gray-500">
                <p>Version 1.0.0</p>
            </div>
        </div>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <main class="flex-grow container mx-auto p-6">
        <div id="authSection" class="min-h-screen flex items-center justify-center bg-gray-50 px-4">
            <div id="loginForm" class="auth-card flex flex-col gap-6 p-6 sm:p-8 w-full max-w-md">
                <div class="text-center">
                    <h2 class="text-2xl font-bold">Welcome Back</h2>
                    <p class="text-gray-500 text-sm mt-2">Sign in to access your Virtual USB Storage</p>
                </div>
                <div>
                    <label for="username" class="block text-sm font-semibold mb-2">Username</label>
                    <input 
                        id="username" 
                        type="text" 
                        autocapitalize="none" 
                        autocorrect="off" 
                        class="input-field w-full p-3 border rounded-md" 
                        placeholder="Enter username" 
                        aria-required="true"
                    >
                    <p id="loginUsernameError" class="error-message text-red-600 text-sm mt-1 hidden"></p>
                </div>
                <div>
                    <label for="password" class="block text-sm font-semibold mb-2">Password</label>
                    <div class="password-wrapper relative">
                        <input 
                            id="password" 
                            type="password" 
                            class="input-field w-full p-3 border rounded-md" 
                            placeholder="Enter password" 
                            aria-required="true"
                        >
                        <button 
                            type="button" 
                            class="show-password absolute right-3 top-3 p-2" 
                            onclick="togglePassword('password')" 
                            aria-label="Toggle password visibility"
                        >
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                    <p id="loginPasswordError" class="error-message text-red-600 text-sm mt-1 hidden"></p>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button 
                        onclick="login()" 
                        class="btn-success bg-gradient-to-r from-green-600 to-green-800 text-white px-4 py-3 rounded-md hover:from-green-800 hover:to-green-600 transition-all text-base min-h-[48px]" 
                        aria-label="Sign in"
                    >
                        Login
                    </button>
                    <button 
                        onclick="showRegister()" 
                        class="btn-warning bg-gradient-to-r from-yellow-600 to-yellow-800 text-white px-4 py-3 rounded-md hover:from-yellow-800 hover:to-yellow-600 transition-all text-base min-h-[48px]" 
                        aria-label="Go to registration"
                    >
                        Register
                    </button>
                </div>
            </div>
            <div id="registerForm" class="auth-card flex flex-col gap-6 p-6 sm:p-8 w-full max-w-md hidden">
                <div class="text-center">
                    <h2 class="text-2xl font-bold">Create Account</h2>
                    <p class="text-gray-500 text-sm mt-2">Join Virtual USB Storage today</p>
                </div>
                <div>
                    <label for="regUsername" class="block text-sm font-semibold mb-2">New Username</label>
                    <input 
                        id="regUsername" 
                        type="text" 
                        autocapitalize="none" 
                        autocorrect="off" 
                        class="input-field w-full p-3 border rounded-md" 
                        placeholder="Choose a username" 
                        aria-required="true"
                    >
                    <p id="regUsernameError" class="error-message text-red-600 text-sm mt-1 hidden"></p>
                </div>
                <div>
                    <label for="regPassword" class="block text-sm font-semibold mb-2">New Password</label>
                    <div class="password-wrapper relative">
                        <input 
                            id="regPassword" 
                            type="password" 
                            class="input-field w-full p-3 border rounded-md" 
                            placeholder="Choose a password" 
                            aria-required="true"
                        >
                        <button 
                            type="button" 
                            class="show-password absolute right-3 top-3 p-2" 
                            onclick="togglePassword('regPassword')" 
                            aria-label="Toggle password visibility"
                        >
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                    <p id="regPasswordError" class="error-message text-red-600 text-sm mt-1 hidden"></p>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button 
                        onclick="register()" 
                        class="btn-success bg-gradient-to-r from-green-600 to-green-800 text-white px-4 py-3 rounded-md hover:from-green-800 hover:to-green-600 transition-all text-base min-h-[48px]" 
                        aria-label="Create account"
                    >
                        Register
                    </button>
                    <button 
                        onclick="showLogin()" 
                        class="btn-danger bg-gradient-to-r from-red-600 to-red-800 text-white px-4 py-3 rounded-md hover:from-red-800 hover:to-red-600 transition-all text-base min-h-[48px]" 
                        aria-label="Cancel registration"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <div id="fileControls" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <div class="flex-grow">
                    <label for="folderName" class="block text-sm font-semibold mb-1">Folder Name</label>
                    <input id="folderName" class="input-field w-full p-3 border rounded-md" placeholder="Enter folder name">
                </div>
                <button onclick="createFolder()" class="btn-primary bg-gradient-to-r from-blue-600 to-blue-800 text-white px-4 py-2 rounded-md hover:from-blue-800 hover:to-blue-600 transition-all mt-4 sm:mt-0">Create Folder</button>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-grow">
                    <label for="fileInput" class="block text-sm font-semibold mb-1">Upload Files</label>
                    <input type="file" id="fileInput" multiple class="input-field w-full p-3 border rounded-md">
                </div>
                <button onclick="saveFiles()" class="btn-success bg-gradient-to-r from-green-600 to-green-800 text-white px-4 py-2 rounded-md hover:from-green-800 hover:to-green-600 transition-all mt-4 sm:mt-0">Save Files</button>
            </div>
            <div id="uploadProgress" class="hidden mt-4">
                <p class="text-sm font-semibold mb-2">Uploading...</p>
                <div class="progress-bar">
                    <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-500 mt-2"></p>
            </div>
        </div>
        <div id="fileList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </main>
    <footer class="bg-gray-900 text-white text-center p-4 text-sm">
        <p>&copy; 2025 Virtual USB Storage</p>
    </footer>

    <script>
        let currentPath = '/';
        let isLoggedIn = false;
        let currentUser = '';
        let db = null;

        // Utility to hash passwords using SHA-256
        async function hashPassword(password) {
            try {
                const msgBuffer = new TextEncoder().encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) {
                console.error('Error hashing password:', error);
                throw error;
            }
        }

        // Initialize IndexedDB for a user
        async function initDB(username) {
            return new Promise((resolve, reject) => {
                console.log(`Initializing database for user: ${username}`);
                const request = indexedDB.open(`user_${username}_db`, 1);
                request.onupgradeneeded = (event) => {
                    console.log('Creating object store for files');
                    const db = event.target.result;
                    db.createObjectStore('files', { keyPath: 'path' });
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log(`Database initialized for user: ${username}`);
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error('Failed to open database:', event.target.error);
                    reject(new Error('Failed to open database: ' + event.target.error.message));
                };
            });
        }

        // Compress image using Canvas
        async function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) return resolve(file);
                console.log(`Compressing image: ${file.name}`);
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob(
                            (blob) => {
                                if (!blob) return reject(new Error('Failed to compress image'));
                                console.log(`Image compressed: ${file.name}`);
                                resolve(new File([blob], file.name, { type: file.type }));
                            },
                            file.type,
                            quality
                        );
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                };
                reader.onerror = () => reject(new Error('Failed to read image'));
                reader.readAsDataURL(file);
            });
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // Show alerts (success or error)
        function showAlert(message, type = 'error') {
            console.log(`Showing alert: ${message} (${type})`);
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000);
        }

        // Real-time input validation
        function setupInputValidation() {
            const inputs = [
                { id: 'username', errorId: 'loginUsernameError', validate: validateUsername },
                { id: 'password', errorId: 'loginPasswordError', validate: validatePassword },
                { id: 'regUsername', errorId: 'regUsernameError', validate: validateUsername },
                { id: 'regPassword', errorId: 'regPasswordError', validate: validatePassword }
            ];

            inputs.forEach(({ id, errorId, validate }) => {
                const input = document.getElementById(id);
                const error = document.getElementById(errorId);
                input.addEventListener('input', () => {
                    const value = input.value.trim();
                    const errorMessage = validate(value);
                    error.textContent = errorMessage || '';
                    error.classList.toggle('hidden', !errorMessage);
                });
            });
        }

        function validateUsername(username) {
            if (!username) return 'Username is required';
            if (!/^[a-zA-Z0-9_-]{3,20}$/.test(username)) {
                return 'Username must be 3-20 alphanumeric characters, underscores, or hyphens';
            }
            return '';
        }

        function validatePassword(password) {
            if (!password) return 'Password is required';
            if (password.length < 6) return 'Password must be at least 6 characters';
            return '';
        }

        function toggleSidebar() {
            console.log('Toggling sidebar');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function createSidebar() {
            console.log('Creating sidebar');
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('sidebarToggle');
            const overlay = document.getElementById('sidebarOverlay');
            const header = document.getElementById('header');
            if (!sidebar || !toggleButton || !overlay || !header) {
                console.error('Sidebar elements missing');
                return;
            }
            header.classList.remove('hidden');
            toggleButton.classList.remove('hidden');
            toggleButton.onclick = toggleSidebar;
            overlay.addEventListener('click', toggleSidebar);
        }

        function removeSidebar() {
            console.log('Removing sidebar');
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('sidebarToggle');
            const overlay = document.getElementById('sidebarOverlay');
            const header = document.getElementById('header');
            if (sidebar) sidebar.classList.remove('open');
            if (toggleButton) toggleButton.classList.add('hidden');
            if (overlay) overlay.classList.remove('active');
            if (header) header.classList.add('hidden');
        }

        async function checkAuthState() {
            console.log('Checking auth state');
            currentUser = localStorage.getItem('currentUser') || '';
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const fileControls = document.getElementById('fileControls');
            const authSection = document.getElementById('authSection');

            if (currentUser) {
                isLoggedIn = true;
                createSidebar();
                const sidebarUserInfo = document.getElementById('sidebarUserInfo');
                const sidebarLoggedInUser = document.getElementById('sidebarLoggedInUser');
                if (sidebarUserInfo && sidebarLoggedInUser) {
                    sidebarLoggedInUser.textContent = `Welcome, ${currentUser}`;
                    sidebarUserInfo.classList.remove('hidden');
                }
                loginForm.classList.add('hidden');
                registerForm.classList.add('hidden');
                fileControls.classList.remove('hidden');
                authSection.classList.add('hidden');
                currentPath = `/${currentUser}/`;
                updatePathDisplay();
                try {
                    if (!db || db.closed) {
                        console.log('Database not initialized or closed, reinitializing');
                        await initDB(currentUser);
                    }
                    await listFiles();
                } catch (error) {
                    console.error('Error during auth state check:', error);
                    showAlert('Error initializing file list: ' + error.message, 'error');
                }
            } else {
                isLoggedIn = false;
                removeSidebar();
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                fileControls.classList.add('hidden');
                authSection.classList.remove('hidden');
                currentPath = '/';
                if (db) {
                    db.close();
                    db = null;
                }
            }
        }

        function updatePathDisplay() {
            console.log('Updating path display:', currentPath);
            const pathDisplay = document.getElementById('currentPath');
            if (pathDisplay && isLoggedIn) {
                const displayPath = currentPath.replace(`/${currentUser}/`, '/');
                pathDisplay.innerHTML = `Current Path: <span class="font-semibold">${displayPath === '/' ? '/root' : displayPath}</span>`;
            }
        }

        function togglePassword(fieldId) {
            console.log(`Toggling password visibility for field: ${fieldId}`);
            const field = document.getElementById(fieldId);
            const icon = field.nextElementSibling.querySelector('svg');
            if (field.type === 'password') {
                field.type = 'text';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z M1 12a11 11 0 0110 0 M1 12a11 11 0 0010 0" />';
            } else {
                field.type = 'password';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
            }
        }

        async function login() {
            console.log('Attempting login');
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const usernameError = document.getElementById('loginUsernameError');
            const passwordError = document.getElementById('loginPasswordError');
            usernameError.classList.add('hidden');
            passwordError.classList.add('hidden');

            const usernameErrorMsg = validateUsername(username);
            const passwordErrorMsg = validatePassword(password);
            if (usernameErrorMsg) {
                usernameError.textContent = usernameErrorMsg;
                usernameError.classList.remove('hidden');
                showAlert(usernameErrorMsg, 'error');
                return;
            }
            if (passwordErrorMsg) {
                passwordError.textContent = passwordErrorMsg;
                passwordError.classList.remove('hidden');
                showAlert(passwordErrorMsg, 'error');
                return;
            }

            try {
                const users = JSON.parse(localStorage.getItem('virtual_usb_users') || '{}');
                const hashedPassword = await hashPassword(password);
                if (users[username] && users[username].password === hashedPassword) {
                    localStorage.setItem('currentUser', username);
                    await initDB(username);
                    await checkAuthState();
                    showAlert('Login successful!', 'success');
                } else {
                    passwordError.textContent = 'Invalid username or password';
                    passwordError.classList.remove('hidden');
                    showAlert('Invalid username or password', 'error');
                }
            } catch (error) {
                console.error('Error during login:', error);
                showAlert('Error during login: ' + error.message, 'error');
            }
        }

        async function register() {
            console.log('Attempting registration');
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const usernameError = document.getElementById('regUsernameError');
            const passwordError = document.getElementById('regPasswordError');
            usernameError.classList.add('hidden');
            passwordError.classList.add('hidden');

            const usernameErrorMsg = validateUsername(username);
            const passwordErrorMsg = validatePassword(password);
            if (usernameErrorMsg) {
                usernameError.textContent = usernameErrorMsg;
                usernameError.classList.remove('hidden');
                showAlert(usernameErrorMsg, 'error');
                return;
            }
            if (passwordErrorMsg) {
                passwordError.textContent = passwordErrorMsg;
                passwordError.classList.remove('hidden');
                showAlert(passwordErrorMsg, 'error');
                return;
            }

            try {
                let users = JSON.parse(localStorage.getItem('virtual_usb_users') || '{}');
                if (users[username]) {
                    usernameError.textContent = 'Username already exists';
                    usernameError.classList.remove('hidden');
                    showAlert('Username already exists', 'error');
                    return;
                }

                const hashedPassword = await hashPassword(password);
                users[username] = { username, password: hashedPassword };
                localStorage.setItem('virtual_usb_users', JSON.stringify(users));

                // Create root folder for the user in IndexedDB
                const db = await initDB(username);
                const tx = db.transaction('files', 'readwrite');
                const store = tx.objectStore('files');
                const rootPath = `/${username}/`;
                await store.put({ path: rootPath, folder: '/', type: 'directory', data: null });
                await tx.complete;

                localStorage.setItem('currentUser', username);
                await checkAuthState();
                showAlert('Registration successful! You are now logged in.', 'success');
            } catch (error) {
                console.error('Error during registration:', error);
                if (error.name === 'QuotaExceededError') {
                    showAlert('Storage quota exceeded. Please clear some browser data and try again.', 'error');
                } else {
                    showAlert('Error during registration: ' + error.message, 'error');
                }
            }
        }

        function logout() {
            console.log('Logging out');
            if (db) {
                db.close();
                db = null;
            }
            localStorage.removeItem('currentUser');
            checkAuthState();
            showAlert('Logged out successfully', 'success');
            const sidebar = document.getElementById('sidebar');
            if (sidebar) sidebar.classList.remove('open');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) sidebarOverlay.classList.remove('active');
        }

        function showRegister() {
            console.log('Showing register form');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            console.log('Showing login form');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        async function createFolder() {
            if (!isLoggedIn) {
                showAlert('Please log in to create folders', 'error');
                return;
            }
            const folderName = document.getElementById('folderName').value.trim();
            if (!folderName) {
                showAlert('Please enter a folder name', 'error');
                return;
            }
            if (!/^[a-zA-Z0-9_-]{1,50}$/.test(folderName)) {
                showAlert('Folder name must be 1-50 alphanumeric characters, underscores, or hyphens', 'error');
                return;
            }
            const folderPath = currentPath + folderName + '/';
            try {
                if (!db || db.closed) {
                    console.log('Database closed, reinitializing');
                    await initDB(currentUser);
                }
                const tx = db.transaction('files', 'readwrite');
                const store = tx.objectStore('files');
                const existing = await store.get(folderPath);
                if (existing) {
                    showAlert('Folder already exists', 'error');
                    return;
                }
                await store.put({ path: folderPath, folder: currentPath, type: 'directory', data: null });
                await tx.complete;
                await listFiles();
                document.getElementById('folderName').value = '';
                showAlert(`Folder "${folderName}" created successfully`, 'success');
            } catch (error) {
                console.error('Error creating folder:', error);
                if (error.name === 'QuotaExceededError') {
                    showAlert('Storage quota exceeded. Please clear some browser data and try again.', 'error');
                } else {
                    showAlert('Error creating folder: ' + error.message, 'error');
                }
            }
        }

        async function saveFiles() {
            if (!isLoggedIn) {
                showAlert('Please log in to save files', 'error');
                return;
            }
            const input = document.getElementById('fileInput');
            const files = Array.from(input.files);
            if (files.length === 0) {
                showAlert('Please select at least one file', 'error');
                return;
            }

            const progressBar = document.getElementById('uploadProgress');
            const progressBarFill = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            progressBar.classList.remove('hidden');

            try {
                if (!db || db.closed) {
                    console.log('Database closed, reinitializing');
                    await initDB(currentUser);
                }
                const tx = db.transaction('files', 'readwrite');
                const store = tx.objectStore('files');
                let processed = 0;
                let successful = 0;

                for (const file of files) {
                    const filePath = currentPath + file.name;

                    // Check for duplicates
                    const existing = await store.get(filePath);
                    if (existing) {
                        showAlert(`File "${file.name}" already exists`, 'error');
                        continue;
                    }

                    // Compress images
                    const processedFile = file.type.startsWith('image/') ? await compressImage(file) : file;

                    // Update progress
                    processed++;
                    const progress = (processed / files.length) * 100;
                    progressBarFill.style.width = `${progress}%`;
                    progressText.textContent = `Processing ${processed} of ${files.length} files`;

                    // Store file as Blob
                    try {
                        await store.put({
                            path: filePath,
                            folder: currentPath,
                            type: file.type || 'application/octet-stream',
                            data: processedFile,
                            size: processedFile.size
                        });
                        successful++;
                    } catch (error) {
                        console.error(`Error processing file "${file.name}":`, error);
                        showAlert(`Failed to process file "${file.name}": ${error.message}`, 'error');
                    }
                }

                await tx.complete;
                await listFiles();
                input.value = '';
                progressBar.classList.add('hidden');
                progressText.textContent = '';
                progressBarFill.style.width = '0%';
                showAlert(`Successfully uploaded ${successful} of ${files.length} file(s)`, 'success');
            } catch (error) {
                console.error('Error saving files:', error);
                progressBar.classList.add('hidden');
                progressText.textContent = '';
                progressBarFill.style.width = '0%';
                if (error.name === 'QuotaExceededError') {
                    showAlert('Storage quota exceeded. Please delete some files or clear browser data and try again.', 'error');
                } else {
                    showAlert('Error saving files: ' + error.message, 'error');
                }
            }
        }

        async function downloadFile(path, name) {
            try {
                if (!db || db.closed) {
                    console.log('Database closed, reinitializing');
                    await initDB(currentUser);
                }
                const tx = db.transaction('files', 'readonly');
                const store = tx.objectStore('files');
                const item = await store.get(path);
                if (!item || !item.data) {
                    showAlert('File not found', 'error');
                    return;
                }
                const url = URL.createObjectURL(item.data);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                a.click();
                URL.revokeObjectURL(url);
                showAlert(`Downloading "${name}"`, 'success');
            } catch (error) {
                console.error('Error downloading file:', error);
                showAlert('Error downloading file: ' + error.message, 'error');
            }
        }

        async function deleteItem(path) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            try {
                if (!db || db.closed) {
                    console.log('Database closed, reinitializing');
                    await initDB(currentUser);
                }
                const tx = db.transaction('files', 'readwrite');
                const store = tx.objectStore('files');
                const itemName = path.endsWith('/') ? path.split('/').filter(p => p).pop() : path.split('/').pop();
                if (path.endsWith('/')) {
                    // Delete folder and its contents
                    const allItems = await store.getAll();
                    for (const item of allItems) {
                        if (item.path.startsWith(path)) {
                            await store.delete(item.path);
                        }
                    }
                } else {
                    // Delete single file
                    await store.delete(path);
                }
                await tx.complete;
                await listFiles();
                showAlert(`"${itemName}" deleted successfully`, 'success');
            } catch (error) {
                console.error('Error deleting item:', error);
                if (error.name === 'QuotaExceededError') {
                    showAlert('Storage quota exceeded. Please clear some browser data and try again.', 'error');
                } else {
                    showAlert('Error deleting item: ' + error.message, 'error');
                }
            }
        }

        async function listFiles() {
            console.log('Listing files for path:', currentPath);
            updatePathDisplay();
            const list = document.getElementById('fileList');
            if (!list) {
                console.error('File list element not found');
                showAlert('Error listing files: File list element not found', 'error');
                return;
            }
            list.innerHTML = '';
            if (!isLoggedIn) {
                console.log('User not logged in');
                list.innerHTML = '<p class="text-center text-gray-500 text-base">Please log in to view files.</p>';
                return;
            }

            try {
                if (!db || db.closed) {
                    console.log('Database closed, reinitializing');
                    await initDB(currentUser);
                }

                // Create breadcrumb
                console.log('Creating breadcrumb');
                const breadcrumb = document.createElement('div');
                breadcrumb.className = 'breadcrumb flex items-center gap-2 mb-4 text-sm text-gray-500';
                const displayParts = currentPath.replace(`/${currentUser}/`, '/').split('/').filter(p => p);
                let cumulativePath = `/${currentUser}/`;
                const rootSpan = document.createElement('span');
                rootSpan.textContent = 'Root';
                rootSpan.className = 'cursor-pointer hover:text-blue-600';
                rootSpan.onclick = () => { currentPath = `/${currentUser}/`; listFiles(); };
                breadcrumb.appendChild(rootSpan);
                displayParts.forEach((part, index) => {
                    cumulativePath += part + '/';
                    const separator = document.createElement('span');
                    separator.textContent = ' / ';
                    breadcrumb.appendChild(separator);
                    const partSpan = document.createElement('span');
                    partSpan.textContent = part;
                    partSpan.className = 'cursor-pointer hover:text-blue-600';
                    partSpan.onclick = ((path) => () => { currentPath = path; listFiles(); })(cumulativePath);
                    breadcrumb.appendChild(partSpan);
                });
                list.appendChild(breadcrumb);

                // Add back button
                if (displayParts.length > 0) {
                    console.log('Adding back button');
                    const backDiv = document.createElement('div');
                    backDiv.className = 'file-item bg-gray-100 rounded-lg p-4 cursor-pointer flex items-center hover:bg-gray-200 transition-all';
                    backDiv.innerHTML = `
                        <svg class="w-6 h-6 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        <span class="text-base font-semibold">Back to Parent</span>
                    `;
                    backDiv.onclick = function() {
                        const fullParts = currentPath.split('/').filter(p => p);
                        fullParts.pop();
                        currentPath = fullParts.length > 0 ? '/' + fullParts.join('/') + '/' : `/${currentUser}/`;
                        listFiles();
                    };
                    list.appendChild(backDiv);
                }

                // Retrieve and display files
                console.log('Retrieving files from IndexedDB');
                const tx = db.transaction('files', 'readonly');
                const store = tx.objectStore('files');
                const request = store.getAll();
                const items = await new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(new Error('Failed to retrieve files: ' + request.error.message));
                });
                console.log('Files retrieved:', items.length);

                const filteredItems = items.filter(item => item.folder === currentPath);
                console.log('Filtered items:', filteredItems.length);

                // Store URLs for cleanup
                const urlsToRevoke = [];

                filteredItems.forEach(item => {
                    if (!item.path || typeof item.folder !== 'string') {
                        console.warn('Invalid item data:', item);
                        return;
                    }
                    const relativeName = item.path.substring(currentPath.length);
                    console.log(`Processing item: ${relativeName}`);
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-item bg-white rounded-lg shadow-md p-4 cursor-pointer relative';
                    let content = '';
                    if (item.type === 'directory') {
                        content = `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                    </svg>
                                    <span class="font-semibold text-base">${relativeName.slice(0, -1)}</span>
                                </div>
                                <button onclick="event.stopPropagation(); deleteItem('${item.path}')" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        `;
                        itemDiv.onclick = function() {
                            currentPath = item.path;
                            listFiles();
                        };
                    } else {
                        const fileSize = item.size ? formatFileSize(item.size) : 'Unknown';
                        content = `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                    </svg>
                                    <div>
                                        <span class="font-semibold text-base">${relativeName}</span>
                                        <p class="text-sm text-gray-500">${fileSize}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="event.stopPropagation(); downloadFile('${item.path}', '${relativeName}')" class="text-green-600 hover:text-green-700">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                        </svg>
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteItem('${item.path}')" class="text-red-600 hover:text-red-800">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `;
                        if (item.type.startsWith('image/') || item.type.startsWith('video/')) {
                            try {
                                const element = item.type.startsWith('image/') ? document.createElement('img') : document.createElement('video');
                                element.src = URL.createObjectURL(item.data);
                                urlsToRevoke.push(element.src);
                                element.className = 'mt-2 rounded max-w-full h-auto';
                                if (item.type.startsWith('video/')) element.controls = true;
                                element.style.maxHeight = '120px';
                                itemDiv.appendChild(element);
                            } catch (error) {
                                console.error(`Error rendering media for ${relativeName}:`, error);
                            }
                        }
                        itemDiv.onclick = function(e) {
                            if (!e.target.closest('button')) {
                                downloadFile(item.path, relativeName);
                            }
                        };
                    }
                    itemDiv.innerHTML = content;
                    list.appendChild(itemDiv);
                });

                // Clean up URLs after rendering
                setTimeout(() => {
                    console.log('Cleaning up URLs:', urlsToRevoke.length);
                    urlsToRevoke.forEach(url => URL.revokeObjectURL(url));
                }, 1000);

                await tx.complete;
                console.log('File listing complete');
            } catch (error) {
                console.error('Error listing files:', error);
                showAlert(`Error listing files: ${error.message || 'Unknown error'}`, 'error');
            }
        }

        // Initialize input validation and touch events
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM content loaded, initializing');
            setupInputValidation();
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    button.click();
                }, { passive: false });
            });
            checkAuthState();
        });
    </script>
</body>
</html>